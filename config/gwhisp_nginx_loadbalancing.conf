server {
    listen 80;
    server_name mydomain.com; # Ensure this matches your DNS entry

    # 1. Frontend - Serves the main UI/static assets
    # Request: http://mydomain.com/
    location / {
        proxy_pass http://gwhisp-frontend:80;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 2. WebSocket Proxy - For /api/ws (e.g., live processing updates)
    # Request: http://mydomain.com/api/ws
    location /api/ws {
        proxy_pass http://gwhisp-backend:3333;

        # CRITICAL for WebSockets
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Standard headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 3. REST API Proxy - For /api (handles all other API calls)
    # Request: http://mydomain.com/api/v1/users or http://mydomain.com/api/transcribe
    location /api {
        # Note: This block should come *after* the more specific /api/ws block
        # to ensure the WebSocket traffic is handled by its dedicated block.

        # If the backend is running on port 3000
        proxy_pass http://gwhisp-backend:3000/whizard;

        # Standard headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/download/{
        # Note: This block should come *after* the more specific /api/ws block
        # to ensure the WebSocket traffic is handled by its dedicated block.

        # If the backend is running on port 3000
        proxy_pass http://gwhisp-backend:3000/download/;

        # Standard headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}